{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f5f3ff">
  <title>EduPath - Панель репетитора</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-primary: #6C4DFF;
      --bg-main: #F9F9FB;
      --bg-secondary: #EDEDED;
      --text-main: #1C1C1E;
      --text-secondary: rgba(60, 60, 67, 0.6);
      --border-color: #D1D1D6;
      --transition: 0.2s ease-in-out;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    body.no-scroll {
      overflow: hidden;
    }
    .btn {
      border-radius: 12px;
      font-weight: 500;
      padding: 10px 20px;
      background: var(--brand-primary);
      color: white;
      border: none;
      cursor: pointer;
      transition: background var(--transition);
    }
    .btn:hover {
      background: #5b3fe6;
    }
    .btn-danger {
      background: #e53e3e;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: background var(--transition);
    }
    .btn-danger:hover {
      background: #c53030;
    }
    input:focus, textarea:focus {
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px var(--brand-primary);
      outline: none;
    }
    header {
      background: white;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    #mobile-menu {
      display: none;
      flex-direction: column;
      padding: 1.5rem;
      background: white;
      border-right: 1px solid var(--border-color);
      height: 100vh;
      width: 16rem;
      max-width: 80%;
      position: fixed;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      transition: transform var(--transition);
      z-index: 100;
    }
    #mobile-menu.show {
      display: flex;
      transform: translateX(0);
    }
    #mobile-menu a {
      color: var(--text-main);
      font-size: 1rem;
      font-weight: 500;
      padding: 0.75rem;
      text-decoration: none;
      transition: color var(--transition);
    }
    #mobile-menu a:hover {
      color: var(--brand-primary);
    }
    #mobile-menu .auth-buttons {
      border-top: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
    }
    #mobile-menu-backdrop {
      display: none;
      background: rgba(0, 0, 0, 0.5);
      height: 100vh;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 99;
    }
    #mobile-menu-backdrop.show {
      display: block;
    }
    #assistant-button {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--brand-primary);
      border-radius: 50%;
      display: grid;
      place-items: center;
      z-index: 100;
      transition: background var(--transition), transform var(--transition);
    }
    #assistant-button:hover {
      background: #5b3fe6;
      transform: scale(1.05);
    }
    #assistant-button img {
      width: 28px;
      height: 28px;
    }
    #assistant-modal {
      display: none;
      position: fixed;
      bottom: 88px;
      right: 16px;
      width: min(380px, calc(100% - 32px));
      max-height: 500px;
      background: white;
      border-radius: 20px;
      z-index: 101;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      flex-direction: column;
    }
    #assistant-modal.show {
      display: flex;
    }
    #assistant-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    #assistant-header button {
      background: none;
      border: none;
      cursor: pointer;
    }
    #assistant-header svg {
      color: var(--text-secondary);
      width: 20px;
      height: 20px;
    }
    #chat-container {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #chat-input-container {
      padding: 12px 16px;
      border-top: 1px solid var(--border-color);
      background: white;
      border-radius: 0 0 20px 20px;
      display: flex;
      gap: 8px;
    }
    #chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-main);
      font-size: 14px;
    }
    #send-button {
      padding: 8px 16px;
      background: var(--brand-primary);
      color: white;
      border-radius: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition);
    }
    #send-button:hover:not(:disabled) {
      background: #5b3fe6;
    }
    #send-button:disabled {
      background: var(--bg-secondary);
      cursor: not-allowed;
    }
    .message {
      padding: 10px 12px;
      border-radius: 16px;
      max-width: 80%;
      font-size: 14px;
    }
    .user-message {
      background: var(--brand-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bot-message {
      background: var(--bg-secondary);
      color: var(--text-main);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: box-shadow var(--transition), transform var(--transition);
    }
    .card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
    }
    .progress-bar {
      height: 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-inner {
      height: 100%;
      background: var(--brand-primary);
      transition: width 0.3s;
    }
    .hero-section h1 {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 800;
      line-height: 1.2;
    }
    textarea {
      resize: none;
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-main);
      font-size: 14px;
    }
    #messages-container {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      height: 500px;
    }
    #student-list {
      width: 250px;
      background: white;
      border-right: 1px solid var(--border-color);
      overflow-y: auto;
    }
    .student-item {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .student-item:hover {
      background: var(--bg-secondary);
    }
    .student-item.active {
      background: var(--brand-primary);
      color: white;
    }
    #message-thread {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
    }
    #message-thread-header {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }
    #message-thread-body {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #message-thread-input {
      padding: 12px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
    }
    @media (min-width: 1024px) {
      .hero-section h1 {
        font-size: 3.5rem;
      }
      h2 {
        font-size: 2rem;
      }
    }
    @media (min-width: 768px) and (max-width: 1023px) {
      .hero-section h1 {
        font-size: 2.5rem;
      }
      h2 {
        font-size: 1.5rem;
      }
    }
    @media (max-width: 767px) {
      .max-w-7xl {
        padding: 0 0.75rem;
      }
      section {
        padding: 2rem 0;
      }
      .hero-section h1 {
        font-size: 1.75rem;
      }
      h2 {
        font-size: 1.5rem;
      }
      #assistant-button {
        height: 48px;
        width: 48px;
      }
      #assistant-button img {
        height: 24px;
        width: 24px;
      }
      #assistant-modal {
        bottom: 80px;
        width: calc(100% - 1.5rem);
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <header>
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <a href="{% url 'teacher_dashboard' %}"><img src="{% static 'Icons/Logo.png' %}" alt="EduPath" class="h-8"></a>
      <nav class="hidden md:flex gap-6 text-sm font-medium desktop-nav">
        <a href="{% url 'teacher_dashboard' %}" class="hover:text-[var(--brand-primary)]">Главная</a>
        <a href="#my-courses" class="hover:text-[var(--brand-primary)]">Мои курсы</a>
        <a href="#create-course" class="hover:text-[var(--brand-primary)]">Создать курс</a>
        <a href="#messages" class="hover:text-[var(--brand-primary)]">Сообщения</a>
        <a href="{% url 'teacher_profile' request.user.id %}" class="hover:text-[var(--brand-primary)]">Моя страница</a>
        <a href="{% url 'profile' %}" class="hover:text-[var(--brand-primary)]">Профиль</a>
      </nav>
      <div class="hidden md:flex items-center gap-3 relative auth-buttons">
         <img src="{{ request.user.avatar_url }}" id="profile-icon" alt="Avatar" class="avatar" title="Профиль">
        <div id="profile-menu" class="absolute right-0 mt-2 w-40 bg-white border border-[var(--border-color)] rounded-lg shadow-lg hidden">
          <a href="{% url 'teacher_profile' request.user.id %}" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-secondary)]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
            Моя страница
          </a>
          <a href="{% url 'profile' %}" class="flex items-center px-4 py-2 text-sm hover:bg-[var(--bg-secondary)]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
            Профиль
          </a>
          <form method="post" action="{% url 'logout' %}" class="flex items-center px-4 py-2 hover:bg-[var(--bg-secondary)]">
            {% csrf_token %}
            <button type="submit" class="flex items-center text-sm">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
              </svg>
              Выйти
            </button>
          </form>
          <a href="{% url 'delete_account' %}" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-[var(--bg-secondary)]">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            Удалить
          </a>
        </div>
      </div>
      <button id="mobile-menu-btn" class="md:hidden mobile-menu-btn" aria-label="Меню" type="button" aria-expanded="false">
        <svg class="open-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-7 h-7">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <svg class="close-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-7 h-7">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div id="mobile-menu-backdrop" class="mobile-menu-backdrop"></div>
    <nav id="mobile-menu" class="md:hidden"></nav>
  </header>

  <!-- Main Content -->
  <main>
    <section class="hero-section max-w-7xl mx-auto px-4 py-12">
      <h1 class="font-extrabold mb-4 text-center">Добро пожаловать, <span class="text-[var(--brand-primary)]">Репетитор</span>!</h1>
      <p class="text-[var(--text-secondary)] text-base mb-6 text-center">Управляйте своими курсами и общайтесь со студентами.</p>
      <a href="#create-course" class="btn w-full md:w-auto text-center">Создать новый курс</a>
    </section>

    <section class="dashboard bg-white py-12">
      <div class="max-w-7xl mx-auto px-4">
        <div class="card">
          <div class="p-6">
            <div class="grid gap-6">
              <div class="flex items-center gap-4">
                <img src="{% static 'Icons/Logo.png' %}" alt="Tutor" class="avatar" loading="lazy">
                <div>
                  <h2 class="text-xl font-semibold">Добро пожаловать, Алексей!</h2>
                  <p class="text-[var(--text-secondary)] text-sm">Ваша панель для управления курсами и общения со студентами</p>
                </div>
              </div>
            </div>
            <div class="grid gap-6 sm:grid-cols-3 mt-6">
              <div class="stats-card bg-[var(--bg-secondary)] p-4 rounded-lg text-center">
                <h3 class="text-2xl font-semibold">12</h3>
                <p class="text-[var(--text-secondary)] text-sm">Активных курсов</p>
              </div>
              <div class="stats-card bg-[var(--bg-secondary)] p-4 rounded-lg text-center">
                <h3 class="text-2xl font-semibold">45</h3>
                <p class="text-[var(--text-secondary)] text-sm">Студентов</p>
              </div>
              <div class="stats-card bg-[var(--bg-secondary)] p-4 rounded-lg text-center">
                <h3 class="text-2xl font-semibold">3</h3>
                <p class="text-[var(--text-secondary)] text-sm">Новых сообщения</p>
              </div>
            </div>
            <div class="grid mt-6">
              <a href="#my-courses" class="btn w-full md:w-auto text-center">Перейти к курсам</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="create-course" class="bg-white py-12">
      <div class="max-w-7xl mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">Создать новый курс</h2>
        <div class="card p-6 max-w-lg mx-auto">
          <form id="create-course-form" enctype="multipart/form-data">
            <div class="mb-4">
              <label for="course-title" class="block text-sm font-medium mb-1">Название курса</label>
              <input id="course-title" type="text" class="w-full p-2 border border-[var(--border-color)] rounded-lg" placeholder="Например, Математика: Подготовка к ЕГЭ" required>
            </div>
            <div class="mb-4">
              <label for="course-description" class="block text-sm font-medium mb-1">Описание курса</label>
              <textarea id="course-description" rows="4" class="w-full" placeholder="Опишите ваш курс..."></textarea>
            </div>
            <div class="mb-4">
              <label for="course-image" class="block text-sm font-medium mb-1">Изображение курса</label>
              <input id="course-image" type="file" accept="image/*" class="w-full p-2 border border-[var(--border-color)] rounded-lg">
            </div>
            <div class="mb-4">
              <label for="course-category" class="block text-sm font-medium mb-1">Категория</label>
              <select id="course-category" class="w-full p-2 border border-[var(--border-color)] rounded-lg" required>
                <option value="" disabled selected>Выберите категорию</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="course-videos" class="block text-sm font-medium mb-1">Ссылки на видео (по одному на строке)</label>
              <textarea id="course-videos" rows="3" class="w-full p-2 border border-[var(--border-color)] rounded-lg" placeholder="https://...\nhttps://..."></textarea>
            </div>
            <div class="mb-4">
              <label for="course-text" class="block text-sm font-medium mb-1">Текстовые материалы (PDF или TXT)</label>
              <input id="course-text" type="file" accept=".pdf,.txt" class="w-full p-2 border border-[var(--border-color)] rounded-lg" required>
            </div>
            <div class="mb-4">
              <label for="course-assignment" class="block text-sm font-medium mb-1">Задание</label>
              <textarea id="course-assignment" rows="3" class="w-full p-2 border border-[var(--border-color)] rounded-lg" placeholder="Опишите задание для студентов..."></textarea>
            </div>
            <div class="mb-4 flex items-center gap-2">
              <input id="with-test" type="checkbox" class="h-4 w-4">
              <label for="with-test" class="text-sm">Добавить тест</label>
            </div>
            <input type="hidden" id="test-data" name="test-data">
            <button type="submit" class="btn w-full text-center">Создать курс</button>
          </form>
        </div>
      </div>

      <!-- Test Creation Modal -->
      <div id="test-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg max-w-lg w-full">
          <h3 class="text-lg font-semibold mb-4">Создать тест</h3>
          <div id="test-questions"></div>
          <button id="add-question" class="btn mt-4">Добавить вопрос</button>
          <div class="flex gap-2 mt-4">
            <button id="save-test" class="btn flex-1">Сохранить</button>
            <button id="cancel-test" class="btn btn-danger flex-1">Отменить</button>
          </div>
        </div>
      </div>
    </section>

    <section id="my-courses" class="bg-[var(--bg-secondary)] py-12">
      <div class="max-w-7xl mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">Ваши курсы</h2>
        <div id="teacher-courses" class="grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
      </div>
    </section>

    <section id="messages" class="bg-white py-12">
      <div class="max-w-7xl mx-auto px-4">
        <h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">Сообщения со студентами</h2>
        <div id="messages-container" class="card">
          <div id="student-list">
            <div class="student-item" data-student-id="student1" data-student-name="Анна К.">
              <img src="{% static 'Icons/Logo.png' %}" alt="Анна К." class="avatar">
              <span>Анна К.</span>
            </div>
          </div>
          <div id="message-thread">
            <div id="message-thread-header">Выберите студента</div>
            <div id="message-thread-body"></div>
            <div id="message-thread-input">
              <textarea id="message-input" placeholder="Напишите сообщение..." rows="2" class="flex-1" disabled></textarea>
              <button id="send-message-btn" class="btn" disabled>Отправить</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="bg-[var(--brand-primary)] text-white py-16 text-center">
      <div class="max-w-3xl mx-auto px-4">
        <h2 class="text-3xl font-bold mb-4">Создавайте новые курсы!</h2>
        <p class="text-base mb-6 text-white/90">Поделитесь своими знаниями со студентами по всему миру.</p>
        <a href="#create-course" class="btn bg-white text-[var(--brand-primary)] hover:bg-gray-100">Создать курс</a>
      </div>
    </section>
  </main>

  <!-- Footer Section -->
  <footer class="mt-auto py-8 px-4 bg-white">
    <div class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
      <div>
        <img src="{% static 'Icons/Logo.png' %}" alt="EduPath" class="h-8 mb-3">
        <p class="text-[var(--text-secondary)] text-sm">Ваш проводник в мир знаний с лучшими репетиторами.</p>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Направления</h3>
        <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
          <li><a href="#math" class="hover:text-[var(--brand-primary)]">Математика</a></li>
          <li><a href="#english" class="hover:text-[var(--brand-primary)]">Английский язык</a></li>
          <li><a href="#programming" class="hover:text-[var(--brand-primary)]">Программирование</a></li>
          <li><a href="#physics" class="hover:text-[var(--brand-primary)]">Физика</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Партнеры</h3>
        <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
          <li><a href="#" class="hover:text-[var(--brand-primary)]">Apple</a></li>
          <li><a href="#" class="hover:text-[var(--brand-primary)]">Google</a></li>
          <li><a href="#" class="hover:text-[var(--brand-primary)]">Meta</a></li>
          <li><a href="#" class="hover:text-[var(--brand-primary)]">Amazon</a></li>
        </ul>
      </div>
      <div>
        <h3 class="font-semibold mb-2">Связаться с нами</h3>
        <ul class="space-y-1 text-sm text-[var(--text-secondary)]">
          <li><a href="mailto:support@edumentor.ru" class="hover:text-[var(--brand-primary)]">support@edumentor.ru</a></li>
          <li><a href="tel:+74951234567" class="hover:text-[var(--brand-primary)]">+7 (495) 123-45-67</a></li>
          <li>Москва, ул. Лермонтова, 15</li>
          <li><a href="#privacy" class="hover:text-[var(--brand-primary)]">Политика конфиденциальности</a></li>
        </ul>
      </div>
    </div>
  </footer>

  <!-- Chat Assistant -->
  <div id="assistant-button" aria-label="Чат" class="assistant-button">
    <img src="{% static 'Icons/Send.png' %}" alt="Assistant">
  </div>
  <div id="assistant-modal" class="assistant-modal"></div>

  <script>
    // Mobile Menu Class
    class MobileMenu {
      constructor({ containerId, backdropId, buttonId, menuItems, isAuthenticated = true }) {
        this.elements = {
          container: document.getElementById(containerId),
          backdrop: document.getElementById(backdropId),
          button: document.getElementById(buttonId),
        };
        this.menuItems = menuItems;
        this.isAuthenticated = isAuthenticated;
        this.isOpen = false;
        this.init();
      }

      init() {
        this.render();
        this.bindEvents();
      }

      render() {
        this.elements.container.innerHTML = `
          ${this.menuItems
            .map(item => `<a href="${item.href}">${item.label}</a>`)
            .join('')}
          <div class="auth-buttons">
            ${
              this.isAuthenticated
                ? `<a href="{% url 'profile' %}"><img src="{% static 'Icons/Logo.png' %}" alt="User Avatar" class="avatar w-12 h-12 mx-auto" title="Профиль" loading="lazy"></a>`
                : `
                  <a href="{% url 'login' %}" class="btn">Войти</a>
                  <a href="{% url 'register' %}" class="btn">Регистрация</a>
                `
            }
          </div>
        `;
      }

      toggle(isOpen) {
        this.isOpen = isOpen;
        this.elements.container.classList.toggle('show', isOpen);
        this.elements.backdrop.classList.toggle('show', isOpen);
        this.elements.button.setAttribute('aria-expanded', isOpen);
        document.body.classList.toggle('no-scroll', isOpen);
      }

      bindEvents() {
        this.elements.button.addEventListener('click', () => {
          this.toggle(!this.isOpen);
        });
        this.elements.backdrop.addEventListener('click', () => this.toggle(false));
      }
    }

    // Chat Service Class
    class ChatService {
      async sendMessage(message) {
        try {
          const response = await fetch('/api/assistant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
            body: JSON.stringify({ message }),
          });
          if (!response.ok) throw new Error('API error');
          return await response.json();
        } catch (error) {
          console.warn('Using mock service:', error);
          return await this.mockSendMessage(message);
        }
      }

      async mockSendMessage(message) {
        await new Promise(resolve => setTimeout(resolve, 500));
        return { success: true, message: findAnswer(message) };
      }
    }

    // Chat Assistant Class
    class ChatAssistant {
      constructor() {
        this.elements = {
          assistantBtn: document.getElementById('assistant-button'),
          modal: document.getElementById('assistant-modal'),
        };
        this.state = {
          isOpen: false,
          messages: [
            {
              content: 'Привет! Помогу с созданием курсов или общением со студентами.',
              isUser: false,
            },
          ],
          input: '',
          isTyping: false,
        };
        this.chatService = new ChatService();
        this.init();
      }

      init() {
        this.render();
        this.bindEvents();
      }

      render() {
        this.elements.modal.innerHTML = `
          <div id="assistant-header">
            <span>Ассистент EduPath</span>
            <button id="assistant-close-btn" aria-label="Закрыть">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div id="chat-container">
            ${this.state.messages
              .map(
                (msg, idx) =>
                  `<div class="message ${msg.isUser ? 'user-message' : 'bot-message'}" key="${idx}">${
                    msg.content
                  }</div>`
              )
              .join('')}
            ${this.state.isTyping ? `<div class="message bot-message">Думаю…</div>` : ''}
          </div>
          <div id="chat-input-container">
            <input id="chat-input" class="chat-input" type="text" placeholder="Задайте вопрос..." aria-label="Сообщение" value="${
              this.state.input
            }">
            <button id="send-button" class="send-button" aria-label="Отправить" ${
              !this.state.input.trim() ? 'disabled' : ''
            }>Отправить</button>
          </div>
        `;
        this.elements.modal.classList.toggle('show', this.state.isOpen);
        this.elements.input = this.elements.modal.querySelector('#chat-input');
        this.elements.sendBtn = this.elements.modal.querySelector('#send-button');
        this.elements.chatContainer = this.elements.modal.querySelector('#chat-container');
        if (this.elements.chatContainer) {
          this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
        }
      }

      async handleSend() {
        if (!this.state.input.trim()) return;
        this.state.messages = [...this.state.messages, { content: this.state.input, isUser: true }];
        this.state.input = '';
        this.state.isTyping = true;
        this.render();
        const { message } = await this.chatService.sendMessage(this.state.messages.at(-1).content);
        this.state.isTyping = false;
        this.state.messages = [...this.state.messages, { content: message, isUser: false }];
        this.render();
      }

      updateInput(value) {
        this.state.input = value;
        if (this.elements.sendBtn) {
          this.elements.sendBtn.disabled = !value.trim();
        }
      }

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      bindEvents() {
        this.elements.assistantBtn.addEventListener('click', () => {
          this.state.isOpen = !this.state.isOpen;
          this.render();
        });
        this.elements.modal.addEventListener('click', e => {
          if (e.target.id === 'assistant-close-btn') {
            this.state.isOpen = false;
            this.render();
          }
          if (e.target.id === 'send-button') {
            this.handleSend();
          }
        });
        this.elements.modal.addEventListener('input', e => {
          if (e.target.id === 'chat-input') {
            this.updateInput(e.target.value);
          }
        });
        this.elements.modal.addEventListener('keypress', e => {
          if (e.target.id === 'chat-input' && e.key === 'Enter') {
            this.handleSend();
          }
        });
        this.elements.modal.addEventListener('input', this.debounce(e => {
          if (e.target.id === 'chat-input') {
            this.updateInput(e.target.value);
          }
        }, 100));
      }
    }

    // Course Manager Class
    class CourseManager {
      constructor() {
        this.bindEvents();
      }

      bindEvents() {
        document.querySelectorAll('#teacher-courses .card').forEach(article => {
          const editBtn = article.querySelector('.edit');
          const deleteBtn = article.querySelector('.delete');
          if (editBtn) {
            editBtn.addEventListener('click', e => {
              e.preventDefault();
              const courseId = article.dataset.courseId;
              fetch(`/api/courses/${courseId}/manage/`)
                .then(r => r.json())
                .then(course => {
                  document.getElementById('course-title').value = course.title;
                  document.getElementById('course-description').value = course.description || '';
                  document.getElementById('course-videos').value = (course.videos || []).join('\n');
                  document.getElementById('course-assignment').value = course.assignment || '';
                  document.getElementById('with-test').checked = !!course.test;
                  if (course.test) {
                    document.getElementById('test-data').value = JSON.stringify(course.test);
                    const container = document.getElementById('test-questions');
                    container.innerHTML = '';
                    course.test.forEach((q, index) => {
                      const block = document.createElement('div');
                      block.className = 'question-block mb-4';
                      block.innerHTML = `
                        <label class="block text-sm font-medium mb-1">Вопрос ${index + 1}</label>
                        <input type="text" class="w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" value="${q.q}" required>
                        <div class="answers">
                          ${q.a.map((ans, i) => `
                            <input type="text" class="answer-input w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" value="${ans}" required>
                          `).join('')}
                        </div>
                        <label class="block text-sm font-medium mb-1">Правильный ответ</label>
                        <select class="w-full p-2 border border-[var(--border-color)] rounded-lg" required>
                          <option value="" disabled>Выберите правильный ответ</option>
                          ${q.a.map((_, i) => `
                            <option value="${i}" ${i === q.c ? 'selected' : ''}>Вариант ${i + 1}</option>
                          `).join('')}
                        </select>
                      `;
                      container.appendChild(block);
                    });
                  }
                  if (course.category) {
                    document.getElementById('course-category').value = course.category;
                  }
                  editId = courseId;
                  document.getElementById('create-course-form').querySelector('button[type=submit]').textContent = 'Сохранить';
                  window.scrollTo({ top: document.getElementById('create-course').offsetTop, behavior: 'smooth' });
                });
            });
          }
          if (deleteBtn) {
            deleteBtn.addEventListener('click', e => {
              e.preventDefault();
              const courseId = article.dataset.courseId;
              fetch(`/api/courses/${courseId}/manage/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
              }).then(() => {
                article.remove();
              });
            });
          }
        });
      }
    }

    // FAQ and Answer Finder
    const stopWords = ['и', 'в', 'на', 'по', 'ли', 'это', 'а', 'к', 'у', 'за', 'то', 'же', 'от', 'с', 'без'];
    const faq = [
      {
        keywords: ['курс', 'что', 'такое', 'представляет', 'собой', 'значит'],
        answer: 'Курс — это серия видеоуроков, практических заданий и поддержки наставника по конкретной теме.'
      },
      {
        keywords: ['как', 'записаться', 'начать', 'присоединиться', 'стартовать', 'подключиться'],
        answer: 'На странице курса нажмите кнопку «Записаться» — и он появится у вас в профиле.'
      },
      {
        keywords: ['бесплатно', 'оплата', 'цена', 'стоимость', 'платно', 'безоплатно'],
        answer: 'Большинство наших курсов доступны бесплатно. Если курс платный, цена указана на его странице.'
      },
      {
        keywords: ['что', 'входит', 'содержит', 'структура', 'состав', 'контент'],
        answer: 'Обычно в курс входят видеоуроки, тесты, практические задания и обратная связь преподавателя.'
      },
      {
        keywords: ['сколько', 'длится', 'длительность', 'идет', 'времени', 'занимает'],
        answer: 'Длительность зависит от темы: как правило, от 2 до 6 недель при комфортном темпе.'
      },
      {
        keywords: ['сертификат', 'выдается', 'получу', 'получить', 'документ'],
        answer: 'После полного прохождения курса и всех заданий вы сможете скачать именной сертификат.'
      },
      {
        keywords: ['сложно', 'уровень', 'подойдет', 'новичку', 'тяжело', 'опыт'],
        answer: 'В описании каждого курса указан рекомендуемый уровень. Множество курсов рассчитаны на абсолютных новичков.'
      },
      {
        keywords: ['повторно', 'ещё', 'раз', 'заново', 'перепройти', 'повторить'],
        answer: 'Вы можете вернуться и пройти курс заново в любое время — доступ остаётся навсегда.'
      },
      {
        keywords: ['профиль', 'аккаунт', 'настройки', 'где', 'посмотреть', 'редактировать'],
        answer: 'Ваш профиль находится в верхнем меню. Там же можно изменить данные, фото и увидеть прогресс.'
      },
      {
        keywords: ['чат', 'написать', 'вопрос', 'наставник', 'преподаватель', 'связаться'],
        answer: 'На странице курса откройте вкладку «Чат» — там можно задать вопрос преподавателю.'
      },
      {
        keywords: ['ошибка', 'баг', 'не', 'работает', 'сбой', 'проблема'],
        answer: 'Опишите, пожалуйста, проблему подробнее — я передам её в техподдержку.'
      },
      {
        keywords: ['ты', 'человек', 'бот', 'ассистент'],
        answer: 'Я виртуальный помощник платформы. Если хочешь пообщаться с живым человеком, напиши «Позвать ассистента».'
      },
      {
        keywords: ['позвать', 'ассистента', 'оператор', 'саппорт'],
        answer: 'Зову ассистента, минуту…'
      }
    ];

    const defaultReply = 'Не уверена, что поняла запрос. Сейчас переключу вас на ассистента, подождите, пожалуйста.';

    function findAnswer(message) {
      const words = message
        .toLowerCase()
        .split(/[^a-zа-яё0-9ё]+/i)
        .filter(w => w && !stopWords.includes(w));
      let best = { answer: defaultReply, score: 0 };
      faq.forEach(item => {
        const score = item.keywords.reduce(
          (sum, kw) => (words.includes(kw) ? sum + 1 : sum),
          0
        );
        if (score > best.score) best = { answer: item.answer, score };
      });
      return best.score > 0 ? best.answer : defaultReply;
    }

    // Utility Functions
    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }

    function loadCategoryOptions() {
      const categories = [
        "Frontend-разработка",
        "Backend-разработка",
        "Мобильная разработка",
        "Data Science и машинное обучение",
        "DevOps и системное администрирование",
        "QA и тестирование",
        "UI/UX дизайн",
        "Базы данных",
        "Веб-дизайн",
        "Кибербезопасность",
        "Бизнес-аналитика",
        "Общее программирование",
        "Soft Skills",
        "Иностранные языки",
        "Подготовка к сертификациям",
        "Математика",
        "Русский язык",
        "Литература",
        "Информатика",
        "Физика",
        "Химия",
        "Биология",
        "История",
        "География",
        "Обществознание",
        "Английский язык",
        "Немецкий язык",
        "Французский язык",
        "Музыка",
        "Изобразительное искусство",
        "Физическая культура",
        "Технология (трудовое обучение)",
        "Основы безопасности жизнедеятельности (ОБЖ)",
        "Экология",
        "Астрономия"
      ];
      const select = document.getElementById('course-category');
      select.innerHTML = '<option value="" disabled selected>Выберите категорию</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
    }

    function addQuestionField() {
      const container = document.getElementById('test-questions');
      const index = container.children.length + 1;
      const block = document.createElement('div');
      block.className = 'question-block mb-4';
      block.innerHTML = `
        <label class="block text-sm font-medium mb-1">Вопрос ${index}</label>
        <input type="text" class="w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" placeholder="Введите вопрос" required>
        <div class="answers">
          <input type="text" class="answer-input w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" placeholder="Вариант 1" required>
          <input type="text" class="answer-input w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" placeholder="Вариант 2" required>
          <input type="text" class="answer-input w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" placeholder="Вариант 3" required>
          <input type="text" class="answer-input w-full p-2 border border-[var(--border-color)] rounded-lg mb-2" placeholder="Вариант 4" required>
        </div>
        <label class="block text-sm font-medium mb-1">Правильный ответ</label>
        <select class="w-full p-2 border border-[var(--border-color)] rounded-lg" required>
          <option value="" disabled selected>Выберите правильный ответ</option>
          <option value="0">Вариант 1</option>
          <option value="1">Вариант 2</option>
          <option value="2">Вариант 3</option>
          <option value="3">Вариант 4</option>
        </select>
      `;
      container.appendChild(block);
    }

    function addCourseCard(course) {
      const article = document.createElement('article');
      article.className = 'card';
      article.dataset.courseId = course.id;
      article.innerHTML = `
        <img src="{% static 'Icons/aa8625109287767.5fd08439c7676.jpg' %}" alt="Course" class="w-full h-40 object-cover rounded-t-lg">
        <div class="p-5">
          <h3 class="text-lg font-semibold mb-2">${course.title}</h3>
          <p class="text-[var(--text-secondary)] text-sm mb-3">0 студентов</p>
          <p class="text-[var(--text-secondary)] text-sm mb-3">Уровень: ${course.level || 'Не указан'}</p>
          <p class="text-[var(--text-secondary)] text-sm mb-3">Длительность: ${course.duration || 'Не указана'}</p>
          <p class="text-[var(--text-secondary)] text-sm mb-3">Описание: ${course.description || 'Нет описания'}</p>
          <div class="flex gap-2">
            <a href="/course/${course.id}/?owner={{ request.user.id }}" target="_blank" class="btn w-full bg-gray-700 hover:bg-gray-800 view">Открыть</a>
            <a href="#" class="btn w-full edit">Редактировать</a>
            <a href="#" class="btn w-full btn-danger delete">Удалить</a>
          </div>
        </div>`;
      document.getElementById('teacher-courses').appendChild(article);
      new CourseManager(); // Rebind events for new cards
    }

    function loadCourses() {
      document.getElementById('teacher-courses').innerHTML = '';
      fetch('/api/courses/my/')
        .then(r => r.json())
        .then(data => { data.forEach(addCourseCard); });
    }

    // Initialize Course Creation
    function initCourseCreation() {
      loadCategoryOptions();

      const courseForm = document.getElementById('create-course-form');
      let editId = null;

      courseForm.addEventListener('submit', e => {
        e.preventDefault();
        const title = document.getElementById('course-title').value.trim();
        const description = document.getElementById('course-description').value.trim();
        const image = document.getElementById('course-image').files[0];
        const category = document.getElementById('course-category').value;
        const videos = document.getElementById('course-videos').value.trim().split('\n').filter(v => v);
        const textFile = document.getElementById('course-text').files[0];
        const assignment = document.getElementById('course-assignment').value.trim();
        const withTest = document.getElementById('with-test').checked;
        const testData = document.getElementById('test-data').value;

        // Validate inputs
        const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/;
        const invalidVideos = videos.filter(v => !youtubeRegex.test(v));
        if (invalidVideos.length > 0) {
          alert('Пожалуйста, введите корректные ссылки на YouTube.');
          return;
        }
        if (!title || !category || !textFile) {
          alert('Название курса, категория и текстовые материалы обязательны.');
          return;
        }
        if (!['application/pdf', 'text/plain'].includes(textFile.type)) {
          alert('Пожалуйста, загрузите файл в формате PDF или TXT.');
          return;
        }
        if (withTest && !testData) {
          alert('Пожалуйста, сохраните тест перед отправкой формы.');
          return;
        }

        const formData = new FormData();
        formData.append('title', title);
        formData.append('description', description);
        formData.append('category', category);
        formData.append('videos', JSON.stringify(videos));
        formData.append('textFile', textFile);
        formData.append('assignment', assignment);
        formData.append('test', withTest ? testData : '');

        if (image) formData.append('image', image);

        const url = editId ? `/api/courses/${editId}/manage/` : '/api/courses/create/';
        const method = editId ? 'PUT' : 'POST';
        fetch(url, {
          method,
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: formData
        }).then(r => r.json()).then(data => {
          editId = null;
          courseForm.querySelector('button[type=submit]').textContent = 'Создать курс';
          courseForm.reset();
          document.getElementById('test-data').value = '';
          document.getElementById('test-questions').innerHTML = '';
          document.getElementById('with-test').checked = false;
          document.getElementById('test-modal').classList.add('hidden');
          loadCourses();
        });
      });

      // Test Modal Handlers
      document.getElementById('with-test').addEventListener('change', function () {
        const modal = document.getElementById('test-modal');
        modal.classList.toggle('hidden', !this.checked);
        if (this.checked) {
          addQuestionField();
        } else {
          document.getElementById('test-questions').innerHTML = '';
          document.getElementById('test-data').value = '';
        }
      });

      document.getElementById('add-question').addEventListener('click', addQuestionField);

      document.getElementById('cancel-test').addEventListener('click', () => {
        document.getElementById('with-test').checked = false;
        document.getElementById('test-modal').classList.add('hidden');
        document.getElementById('test-questions').innerHTML = '';
        document.getElementById('test-data').value = '';
      });

      document.getElementById('save-test').addEventListener('click', () => {
        const questions = [];
        document.querySelectorAll('#test-questions .question-block').forEach((block, i) => {
          const question = block.querySelector('input[type="text"]').value.trim();
          const answers = Array.from(block.querySelectorAll('.answer-input')).map(input => input.value.trim());
          const correct = block.querySelector('select').value;
          if (question && answers.every(a => a) && correct !== '') {
            questions.push({ q: question, a: answers, c: Number(correct) });
          }
        });
        if (questions.length === 0) {
          alert('Добавьте хотя бы один полный вопрос.');
          return;
        }
        document.getElementById('test-data').value = JSON.stringify(questions);
        document.getElementById('test-modal').classList.add('hidden');
      });
    }

    // Initialize Application
    let editId = null;

    const initApp = () => {
      new MobileMenu({
        containerId: 'mobile-menu',
        backdropId: 'mobile-menu-backdrop',
        buttonId: 'mobile-menu-btn',
        menuItems: [
          { href: '{% url "teacher_dashboard" %}', label: 'Главная' },
          { href: '#my-courses', label: 'Мои курсы' },
          { href: '#create-course', label: 'Создать курс' },
          { href: '#messages', label: 'Сообщения' },
          { href: '{% url "teacher_profile" request.user.id %}', label: 'Моя страница' },
          { href: '{% url "profile" %}', label: 'Профиль' },
        ],
        isAuthenticated: true,
      });
      new ChatAssistant();
      new CourseManager();

      // Profile Dropdown
      const profileIcon = document.getElementById('profile-icon');
      const profileMenu = document.getElementById('profile-menu');
      document.addEventListener('click', e => {
        if (profileIcon.contains(e.target)) {
          profileMenu.classList.toggle('hidden');
        } else if (!profileMenu.contains(e.target)) {
          profileMenu.classList.add('hidden');
        }
      });

      initCourseCreation();
      loadCourses();
    };

    // Run on DOM load
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>