{% load static %}
<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>NeXus — Чат с ИИ-консультантом</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
    :root {
      --color-primary: #007AFF; /* Apple blue */
      --color-bg: #F5F5F7; /* Light gray background */
      --color-bg-secondary: #FFFFFF; /* White for cards */
      --color-text: #1D1D1F; /* Dark text */
      --color-text-secondary: #6E6E73; /* Secondary text */
      --color-border: #D2D2D7; /* Subtle border */
      --color-shadow: rgba(0, 0, 0, 0.08); /* Soft shadow */
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Inter', sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
      overflow-wrap: anywhere;
    }
    .text-secondary { color: var(--color-text-secondary); }
    button, a, input {
      transition: all 0.3s ease;
    }
    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: 18px;
      box-shadow: 0 4px 30px var(--color-shadow);
    }
    button:hover, a:hover {
      transform: translateY(-1px);
    }
    .message {
      max-width: 75%;
      padding: 0.75rem 1.25rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .animate-fade-in {
      animation: fade-in 0.3s ease forwards;
    }
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .user-message {
      align-self: flex-end;
      background: var(--color-primary);
      color: #fff;
      border-bottom-right-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .bot-message {
      align-self: flex-start;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      color: var(--color-text);
      border-bottom-left-radius: 0.25rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .message-image {
      max-width: 50%;
      padding: 0.25rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
    }
    .message-image img {
      width: 100%;
      border-radius: 0.5rem;
    }
    .media-preview-item {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 0.5rem;
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    .media-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .media-preview-item button {
      position: absolute;
      top: 0.25rem;
      right: 0.25rem;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .media-preview-item button:hover {
      background: rgba(0, 0, 0, 0.7);
    }
    @keyframes slide-in {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-in { animation: slide-in 0.3s ease; }
    .test-option {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .test-option:hover {
      background: #0051CC;
      transform: translateY(-2px);
    }
    .test-question {
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .university-button {
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: 0.75rem;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
    }
    .university-button:hover {
      background: #0051CC;
      transform: translateY(-1px);
    }
    #mobile-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    #mobile-menu.open { max-height: 1000px; }
    #mobile-menu-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 40;
      transition: opacity 0.3s ease-in-out;
    }
    #mobile-menu-backdrop.show { display: block; opacity: 1; }
    #mobile-menu a,
    #mobile-menu button {
      font-size: 1.125rem;
      padding: 0.75rem 1.5rem;
      border-radius: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    #mobile-menu a:hover,
    #mobile-menu button:hover {
      color: var(--color-primary);
    }
    #mobile-btn svg {
      width: 28px;
      height: 28px;
      stroke: var(--color-text);
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white border-b border-[var(--color-bg-secondary)] sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="{% url 'main_menu' %}">
        <img src="{% static 'Icons/Logo.png' %}?v=2" alt="NeXus Logo" class="h-12 md:h-14" />
      </a>
      
      <nav class="hidden md:flex space-x-8 text-sm font-medium">
        <a href="{% url 'main_menu' %}" class="hover:text-[var(--color-primary)]">Главная</a>
        <a href="{% url 'course_view' %}" class="hover:text-[var(--color-primary)]">ВУЗы</a>
        <a href="{% url 'about' %}" class="hover:text-[var(--color-primary)]">О нас</a>
        <a href="{% url 'contacts' %}" class="text-[var(--color-primary)] font-semibold">ИИ - ассистент</a>
      </nav>
      
      <div class="hidden md:flex items-center gap-4">
        <a href="#" class="text-[var(--color-primary)] hover:underline text-sm font-medium">Войти</a>
        <a href="#" class="bg-[var(--color-primary)] hover:bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-semibold transition">Регистрация</a>
      </div>
      
      <button id="mobile-btn" class="md:hidden" aria-label="Открыть меню" type="button" aria-expanded="false" aria-controls="mobile-menu">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
    
    <div id="mobile-menu-backdrop" tabindex="-1"></div>
    <nav id="mobile-menu" class="md:hidden flex flex-col px-6 pb-6 space-y-4 text-base font-medium bg-white border-t border-[var(--color-bg-secondary)] z-50 relative" aria-label="Мобильное меню">
      <a href="{% url 'main_menu' %}" class="hover:text-[var(--color-primary)]">Главная</a>
      <a href="{% url 'course_view' %}" class="hover:text-[var(--color-primary)]">ВУЗы</a>
      <a href="{% url 'about' %}" class="hover:text-[var(--color-primary)]">О нас</a>
      <a href="{% url 'contacts' %}" class="text-[var(--color-primary)] font-semibold">ИИ - ассистент</a>
      <div class="flex flex-col gap-4 mt-4">
        <a href="{% url 'login' %}" class="text-[var(--color-primary)] hover:underline w-full text-center">Войти</a>
        <a href="{% url 'register' %}" class="bg-[var(--color-primary)] hover:bg-indigo-600 text-white w-full rounded-xl font-semibold transition py-3 text-center">Регистрация</a>
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-5xl mx-auto px-6 py-12 flex-1">
    <h1 class="text-3xl font-semibold tracking-tight mb-8">Чат с ИИ-консультантом по профориентации</h1>
    <div class="card flex flex-col" style="min-height: calc(100vh - 12rem);">
      <div id="chat-container" class="flex-1 p-4 overflow-y-auto space-y-3 bg-[var(--color-bg)] flex flex-col">
        <!-- Messages will be loaded here -->
      </div>
      <div class="p-4 border-t border-[var(--color-border)]">
        <div id="media-preview" class="hidden flex gap-2 mb-4 flex-wrap"></div>
        <form id="chat-form" class="flex gap-2" style="flex-wrap: wrap;">
          <input type="text" id="chat-input" placeholder="Задайте вопрос о профессиях, вузах или профориентации..." class="flex-grow min-w-[150px] border border-[var(--color-border)] rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)]" />
          <label for="chat-file" class="cursor-pointer text-[var(--color-primary)] hover:underline flex items-center px-3 shrink-0" title="Прикрепить изображение">
            <i class="fas fa-paperclip"></i>
          </label>
          <input type="file" id="chat-file" accept="image/*" style="display:none" multiple />
          <button id="cancel-media" type="button" class="bg-red-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-red-600 shadow-sm hidden">Отмена</button>
          <button type="submit" class="bg-[var(--color-primary)] text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-[#0051CC] shadow-sm">Отправить</button>
          <button type="button" id="clear-chat" class="bg-gray-500 text-white rounded-xl font-semibold px-4 py-2 shrink-0 min-w-[80px] hover:bg-gray-600 shadow-sm">Новый чат</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  {% include 'partials/footer.html' %}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      
      // Mobile Menu
      const btn = document.getElementById('mobile-btn');
      const menu = document.getElementById('mobile-menu');
      const backdrop = document.getElementById('mobile-menu-backdrop');

      function toggleMenu() {
        const isOpen = menu.classList.toggle('open');
        backdrop.classList.toggle('show', isOpen);
        btn.setAttribute('aria-expanded', isOpen);
      }

      btn.addEventListener('click', toggleMenu);
      backdrop.addEventListener('click', toggleMenu);

      // Принудительная перезагрузка логотипа для обхода кэша
      window.addEventListener('load', function() {
        const logos = document.querySelectorAll('img[alt="NeXus Logo"]');
        logos.forEach(logo => {
          const originalSrc = logo.src.split('?')[0];
          logo.src = originalSrc + '?v=' + new Date().getTime();
        });
      });

      // Chat Functionality
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatContainer = document.getElementById('chat-container');
      const chatFileInput = document.getElementById('chat-file');
      const mediaPreview = document.getElementById('media-preview');
      const cancelMediaButton = document.getElementById('cancel-media');
      const clearChatButton = document.getElementById('clear-chat');

      const stopWords = ['и', 'в', 'на', 'по', 'ли', 'это', 'а', 'к', 'у', 'за', 'то', 'же', 'от', 'с', 'без'];
      
      // БАЗА ДАННЫХ УНИВЕРСИТЕТОВ КАЗАХСТАНА
      const universities = {
        "kaznu": {
          name: "Казахский национальный университет им. аль-Фараби (KazNU / Farabi)",
          military: "есть (военная подготовка, набор по конкурсу)",
          scores: "пороговые баллы ЕНТ варьируются по программам (от ~65 и выше)",
          budget: "есть бюджетные места, количество указано в таблицах пороговых баллов",
          directions: "гуманитарные науки, филология, социальные науки, естественные науки, математика, ИT, экономика, юриспруденция, педагогика",
          aliases: ["казну", "farabi", "аль-фараби", "казахский национальный университет"]
        },
        "abai": {
          name: "Казахский национальный педагогический университет им. Абая (Abai University)",
          military: "есть (отбор на конкурсной основе)",
          scores: "для педагогических направлений часто выше (от ~70), для других от ~65",
          budget: "есть бюджетные места, публикуются по группам образовательных программ",
          directions: "педагогика, дошкольное и школьное образование, методики преподавания, физкультура, музыка, искусство",
          aliases: ["абай", "abai", "казахский педагогический", "кзнпу"]
        },
        "satbayev": {
          name: "Satbayev University (Сатбаев)",
          military: "есть (приём на кафедру проводится на конкурсной основе)",
          scores: "минимум для конкурса грантов от 65 баллов",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, математика, информационные системы, информационная безопасность, компьютерные науки",
          aliases: ["сатбаев", "satbayev", "сатпаев"]
        },
        "kaznmu": {
          name: "Казахский национальный медицинский университет им. С.Д. Асфендиярова (KazNMU)",
          military: "есть (правила приёма на военную кафедру)",
          scores: "высокие баллы (часто >110 в зависимости от программы)",
          budget: "есть бюджетные места по специальностям",
          directions: "медицина (лечебное дело), педиатрия, стоматология, фармация, сестринское дело, общественное здоровье",
          aliases: ["казнму", "медицинский", "асфендияров"]
        },
        "abylai": {
          name: "Казахский университет международных отношений и мировых языков им. Абылай хана (KazUIR)",
          military: "информация опубликована на сайте (см. раздел «Абитуриентам»)",
          scores: "разные по программам, публикуются на сайте",
          budget: "есть бюджетные места, публикуются ежегодно",
          directions: "международные отношения, дипломатия, лингвистика, регионоведение, перевод, политология",
          aliases: ["абылай", "abylai", "казахский университет международных отношений"]
        },
        "kbtu": {
          name: "Казахстанско-Британский технический университет (KBTU)",
          military: "есть (набор на военную кафедру)",
          scores: "высокий конкурс (100+ или 110+ для популярных направлений)",
          budget: "есть бюджетные места по программам",
          directions: "инженерия, IT, менеджмент в технических сферах, химинжиниринг, материалы, электроника, финансы",
          aliases: ["кбту", "kbtu", "британский технический"]
        },
        "dku": {
          name: "Казахстанско-Немецкий университет (DKU)",
          military: "информация на официальном сайте",
          scores: "пороги зависят от группы образовательных программ",
          budget: "есть гранты и квоты (частный/международный вуз)",
          directions: "менеджмент, международное сотрудничество, инженерные программы с немецкой компонентой, языки, бизнес-образование",
          aliases: ["дку", "dku", "немецкий университет"]
        },
        "krmu": {
          name: "Казахстанско-Российский медицинский университет (КРМУ)",
          military: "есть (отбор на военную кафедру)",
          scores: "высокие баллы (от 70 и выше для участия в конкурсе)",
          budget: "есть бюджетные места по специальностям",
          directions: "лечебное дело, зубоврачебное дело, сестринское дело, общественное здоровье",
          aliases: ["крму", "krmu", "российский медицинский"]
        },
        "atu": {
          name: "Алматинский технологический университет (АТУ)",
          military: "есть (набор на военную подготовку)",
          scores: "пороги по программам (от ~45–65 и выше)",
          budget: "есть бюджетные места",
          directions: "пищевая промышленность, текстиль, технологии, инженерные специальности, IT, экономика, туризм и сервис",
          aliases: ["ату", "atu", "алматинский технологический"]
        },
        "aues": {
          name: "Алматинский университет энергетики и связи (AUES)",
          military: "есть (публикуются объявления о наборе)",
          scores: "есть проходные баллы по программам",
          budget: "есть бюджетные места",
          directions: "энергетика, электротехника, коммуникации, ИT, транспортные технологии",
          aliases: ["ауэс", "aues", "энергетики и связи", "даукеев"]
        },
        "ageu": {
          name: "Алматинский гуманитарно-экономический университет (АГЭУ)",
          military: "есть информация о военной кафедре",
          scores: "пороговые баллы по программам публикуются",
          budget: "есть гранты/бюджетные места",
          directions: "экономика, статистика, менеджмент, право, бухгалтерия, IT, медиа/дизайн",
          aliases: ["агеу", "ageu", "гуманитарно-экономический"]
        },
        "alma": {
          name: "Алматы Менеджмент Университет (AlmaU)",
          military: "нет (бизнес/менеджмент вуз)",
          scores: "проходной балл примерно 75–101 в зависимости от программы",
          budget: "есть гранты/квоты на бакалавриат и магистратуру",
          directions: "менеджмент, финансы, маркетинг, право, бизнес-аналитика, управление человеческими ресурсами, информационные системы",
          aliases: ["алмау", "almau", "менеджмент университет"]
        }
      };

      // РАСШИРЕННЫЙ FAQ ДЛЯ ПРОФОРИЕНТАЦИИ
      const faq = [
        {
          keywords: ['профессия', 'профессии', 'кем стать', 'выбор профессии', 'карьера', 'профориентация', 'будущая профессия', 'специальность', 'профессиональный выбор', 'кем работать', 'какую профессию выбрать', 'профессиональное самоопределение', 'выбрать профессию', 'определиться с профессией', 'будущая работа', 'карьерный путь', 'профессиональная деятельность'],
          answer: 'На платформе NeXus вы можете пройти профориентационные тесты, которые помогут определить подходящие профессии на основе ваших интересов, способностей и оценок. Мы анализируем ваши склонности и предлагаем профессии, которые будут вам интересны и востребованы на рынке труда.'
        },
        {
          keywords: ['тест', 'тесты', 'профтест', 'профориентационный', 'пройти тест', 'опрос', 'анкета', 'диагностика', 'тестирование', 'пройти опрос', 'пройти анкету', 'профориентационный тест', 'тест на профориентацию', 'тест на профессию', 'пройти диагностику', 'тестирование способностей', 'опросник', 'психологический тест'],
          answer: 'В разделе "Тесты" доступны различные профориентационные тесты. После прохождения вы получите персональные рекомендации по профессиям и направлениям обучения. Хотите пройти быстрый тест прямо сейчас? Напишите "пройти тест" или "начать тестирование".'
        },
        {
          keywords: ['пройти тест', 'начать тест', 'начать тестирование', 'пройти опрос', 'запустить тест', 'начать профтест', 'пройти профориентацию', 'начать профориентацию', 'хочу тест', 'можно тест', 'давай тест', 'протестируй меня', 'проведи тест', 'сделать тест', 'пройти проверку', 'тестируй'],
          answer: 'test' // Специальный маркер для запуска теста
        },
        {
          keywords: ['военная кафедра', 'военка', 'армия', 'военная подготовка', 'военное дело', 'военную', 'кафедра', 'военную подготовку', 'служба', 'отсрочка'],
          answer: 'military' // Специальный маркер для вопроса о военной кафедре
        },
        {
          keywords: ['баллы', 'проходной балл', 'ент', 'экзамен', 'результаты', 'минимальный балл', 'вступительные', 'баллы ент', 'средний балл', 'проходные баллы', 'баллы для поступления', 'минимальные баллы', 'требуемые баллы', 'результаты экзаменов', 'вступительные испытания', 'экзаменационные баллы', 'пороговый'],
          answer: 'scores' // Специальный маркер для вопроса о баллах
        },
        {
          keywords: ['бюджет', 'грант', 'стипендия', 'бюджетное', 'бесплатное', 'обучение', 'финансирование', 'стоимость', 'цена', 'бюджетное место', 'контракт', 'оплата обучения', 'стоимость обучения', 'бесплатное обучение', 'гранты на обучение', 'образовательные гранты', 'стипендии для студентов', 'финансовая помощь'],
          answer: 'budget' // Специальный маркер для вопроса о бюджете
        },
        {
          keywords: ['направления', 'специальности', 'факультеты', 'программы', 'образование', 'обучение', 'что изучать', 'какие направления', 'специальность', 'факультет', 'образовательная программа'],
          answer: 'directions' // Специальный маркер для вопроса о направлениях
        },
        {
          keywords: ['университет', 'вуз', 'институт', 'поступление', 'высшее образование', 'факультет', 'направление', 'специальность вуза', 'высшее учебное заведение', 'поступить в вуз', 'выбрать вуз', 'подобрать университет', 'куда поступить', 'выбор университета', 'рейтинг вузов', 'топ университетов', 'лучшие вузы', 'вузы россии', 'универ'],
          answer: 'university' // Специальный маркер для общего вопроса об университетах
        },
        // ... остальные FAQ остаются без изменений
      ];

      const defaultReply = 'Не совсем понял ваш вопрос о профориентации или выборе вуза. Попробуйте переформулировать или напишите "Позвать консультанта" для связи со специалистом. Можете также рассказать о своих интересах - я помогу подобрать профессии!';

      // ДАННЫЕ ДЛЯ ПРОФОРИЕНТАЦИОННОГО ТЕСТА
      const proforientationTest = [
        {
          question: "Какой тип деятельности вам больше нравится?",
          options: [
            "Работа с людьми (общение, помощь, обучение)",
            "Работа с техникой и технологиями",
            "Творческая работа (искусство, дизайн, музыка)",
            "Аналитическая работа (исследования, анализ данных)",
            "Организационная работа (управление, планирование)"
          ]
        },
        {
          question: "Что вам интереснее всего?",
          options: [
            "Естественные науки (биология, химия, медицина)",
            "Техника и информационные технологии",
            "Искусство и культура",
            "Общественные науки и право",
            "Бизнес и экономика"
          ]
        },
        {
          question: "Как вы предпочитаете работать?",
          options: [
            "В команде, общаясь с коллегами",
            "Самостоятельно, сосредоточенно",
            "Творчески, выражая свои идеи",
            "Анализируя информацию и данные",
            "Организуя процессы и людей"
          ]
        },
        {
          question: "Что для вас важнее в работе?",
          options: [
            "Помощь другим людям",
            "Создание технических решений",
            "Самовыражение и креативность",
            "Поиск истины и анализ",
            "Достижение результатов и успеха"
          ]
        },
        {
          question: "Какой школьный предмет вам нравится больше всего?",
          options: [
            "Биология, химия, география",
            "Математика, физика, информатика",
            "Литература, искусство, музыка",
            "История, обществознание, право",
            "Экономика, бизнес-предметы"
          ]
        }
      ];

      const testResults = {
        "Человеко-ориентированные профессии": ["Психолог", "Учитель", "Врач", "Социальный работник", "HR-специалист"],
        "Технические профессии": ["Инженер", "Программист", "Аналитик данных", "Сетевой администратор", "Технический специалист"],
        "Творческие профессии": ["Дизайнер", "Художник", "Музыкант", "Архитектор", "Копирайтер"],
        "Научно-исследовательские профессии": ["Ученый", "Исследователь", "Аналитик", "Эксперт", "Консультант"],
        "Организационные профессии": ["Менеджер", "Предприниматель", "Руководитель", "Организатор", "Координатор"]
      };

      let currentTestState = {
        inProgress: false,
        currentQuestion: 0,
        answers: [],
        userInterests: []
      };

      let currentUniversityContext = null;

      function findUniversityByName(name) {
        const lowerName = name.toLowerCase();
        for (const [key, uni] of Object.entries(universities)) {
          if (uni.aliases.some(alias => lowerName.includes(alias)) || 
              lowerName.includes(key) ||
              lowerName.includes(uni.name.toLowerCase())) {
            return key;
          }
        }
        return null;
      }

      function getUniversityInfo(universityKey, infoType) {
        const uni = universities[universityKey];
        if (!uni) return null;

        switch(infoType) {
          case 'military':
            return `🎖️ ${uni.name}\n\nВоенная кафедра: ${uni.military}`;
          case 'scores':
            return `📊 ${uni.name}\n\nПороговые баллы ЕНТ: ${uni.scores}`;
          case 'budget':
            return `💰 ${uni.name}\n\nБюджетные места: ${uni.budget}`;
          case 'directions':
            return `🎯 ${uni.name}\n\nОсновные направления: ${uni.directions}`;
          case 'all':
            return `🏫 ${uni.name}\n\n🎖️ Военная кафедра: ${uni.military}\n📊 Баллы ЕНТ: ${uni.scores}\n💰 Бюджет: ${uni.budget}\n🎯 Направления: ${uni.directions}`;
          default:
            return `🏫 ${uni.name}\n\n${uni.directions}`;
        }
      }

      function showUniversityButtons(messageType) {
        const buttonsMessage = document.createElement('div');
        buttonsMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>Выберите университет для получения информации:</strong><br><br>
          <div style="display: flex; flex-wrap: wrap; gap: 5px;">`;
        
        Object.entries(universities).forEach(([key, uni]) => {
          const shortName = uni.name.split('(')[0].trim();
          html += `<button class="university-button" onclick="handleUniversitySelect('${key}', '${messageType}')">${shortName}</button>`;
        });
        
        html += `</div></div>`;
        buttonsMessage.innerHTML = html;
        chatContainer.appendChild(buttonsMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleUniversitySelect(universityKey, infoType) {
        const info = getUniversityInfo(universityKey, infoType);
        if (info) {
          const infoMessage = document.createElement('div');
          infoMessage.className = 'message bot-message animate-fade-in';
          infoMessage.textContent = info;
          chatContainer.appendChild(infoMessage);
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }
      }

      function findAnswer(message) {
        const words = message
          .toLowerCase()
          .split(/[^a-zа-яё0-9ё]+/i)
          .filter(w => w && !stopWords.includes(w));
        let best = { answer: defaultReply, score: 0 };
        
        faq.forEach(item => {
          const score = item.keywords.reduce(
            (sum, kw) => words.includes(kw) ? sum + 1 : sum,
            0
          );
          if (score > best.score) best = { answer: item.answer, score };
        });

        // Проверка на запрос теста
        if (best.answer === 'test' || words.some(w => ['тест', 'профориентация', 'опрос'].includes(w))) {
          startProforientationTest();
          return '';
        }

        // Проверка на вопросы об университетах
        if (best.answer === 'military' || best.answer === 'scores' || best.answer === 'budget' || best.answer === 'directions') {
          // Сначала ищем упоминание конкретного университета
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, best.answer);
          } else {
            showUniversityButtons(best.answer);
            return '';
          }
        }

        // Общий вопрос об университетах
        if (best.answer === 'university') {
          const foundUni = findUniversityByName(message);
          if (foundUni) {
            return getUniversityInfo(foundUni, 'all');
          } else {
            showUniversityButtons('all');
            return '';
          }
        }

        return best.answer;
      }

      function startProforientationTest() {
        currentTestState = {
          inProgress: true,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        showTestQuestion(0);
      }

      function showTestQuestion(questionIndex) {
        const question = proforientationTest[questionIndex];
        const testMessage = document.createElement('div');
        testMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>Вопрос ${questionIndex + 1}/${proforientationTest.length}</strong><br>
          ${question.question}
          <div style="margin-top: 10px;">`;
        
        question.options.forEach((option, index) => {
          html += `<button class="test-option" onclick="handleTestAnswer(${questionIndex}, ${index})">${option}</button>`;
        });
        
        html += `</div></div>`;
        testMessage.innerHTML = html;
        chatContainer.appendChild(testMessage);
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleTestAnswer(questionIndex, answerIndex) {
        currentTestState.answers[questionIndex] = answerIndex;
        currentTestState.currentQuestion++;
        
        if (currentTestState.currentQuestion < proforientationTest.length) {
          showTestQuestion(currentTestState.currentQuestion);
        } else {
          finishTest();
        }
      }

      function finishTest() {
        const result = calculateTestResult();
        const resultMessage = document.createElement('div');
        resultMessage.className = 'message bot-message animate-fade-in';
        
        let html = `<div class="test-question">
          <strong>🎉 Результаты вашего теста!</strong><br><br>
          <strong>Вам подходят профессии типа: ${result.type}</strong><br><br>
          <strong>Рекомендуемые профессии:</strong><br>
          ${result.professions.join(', ')}<br><br>
          <strong>Следующие шаги:</strong><br>
          1. Изучите подробнее рекомендованные профессии<br>
          2. Посмотрите подходящие вузы в нашем каталоге<br>
          3. Пройдите углубленное тестирование<br><br>
          Хотите получить персонализированные рекомендации по вузам?
        </div>`;
        
        resultMessage.innerHTML = html;
        chatContainer.appendChild(resultMessage);
        
        currentTestState.inProgress = false;
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function calculateTestResult() {
        const answerCounts = [0, 0, 0, 0, 0];
        currentTestState.answers.forEach(answer => {
          if (answer >= 0 && answer < answerCounts.length) {
            answerCounts[answer]++;
          }
        });
        
        const maxIndex = answerCounts.indexOf(Math.max(...answerCounts));
        const types = ["Человеко-ориентированные профессии", "Технические профессии", "Творческие профессии", "Научно-исследовательские профессии", "Организационные профессии"];
        
        return {
          type: types[maxIndex],
          professions: testResults[types[maxIndex]]
        };
      }

      // Делаем функции глобальными для обработки кликов
      window.handleTestAnswer = handleTestAnswer;
      window.handleUniversitySelect = handleUniversitySelect;

      let pendingMedia = [];

      function clearMediaPreview() {
        pendingMedia = [];
        mediaPreview.innerHTML = '';
        mediaPreview.classList.add('hidden');
        cancelMediaButton.classList.add('hidden');
      }

      function updateMediaPreview() {
        mediaPreview.innerHTML = '';
        pendingMedia.forEach((media, index) => {
          const div = document.createElement('div');
          div.className = 'media-preview-item';
          div.innerHTML = `
            <img src="${media}" alt="Preview">
            <button data-index="${index}" type="button"><i class="fas fa-times"></i></button>
          `;
          mediaPreview.appendChild(div);
          div.querySelector('button').addEventListener('click', () => {
            pendingMedia.splice(index, 1);
            updateMediaPreview();
          });
        });
        mediaPreview.classList.toggle('hidden', pendingMedia.length === 0);
        cancelMediaButton.classList.toggle('hidden', pendingMedia.length === 0);
      }

      function handleFileInput(e) {
        const files = e.target.files;
        if (files.length) {
          Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) {
              alert('Пожалуйста, выберите изображение');
              return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
              pendingMedia.push(event.target.result);
              updateMediaPreview();
            };
            reader.readAsDataURL(file);
          });
          e.target.value = '';
        }
      }

      function createNewChat() {
        // Очищаем контейнер чата
        chatContainer.innerHTML = '';
        
        // Сбрасываем состояние теста
        currentTestState = {
          inProgress: false,
          currentQuestion: 0,
          answers: [],
          userInterests: []
        };
        
        // Сбрасываем контекст университета
        currentUniversityContext = null;
        
        // Показываем приветственное сообщение
        const welcomeMsg = document.createElement('div');
        welcomeMsg.className = 'message bot-message animate-fade-in';
        welcomeMsg.textContent = 'Привет! Я ИИ-консультант NeXus. Помогу с выбором профессии, подбором вуза и профориентацией. Можете пройти быстрый тест или задать вопрос о конкретных университетах Казахстана!';
        chatContainer.appendChild(welcomeMsg);
        
        // Очищаем поле ввода
        chatInput.value = '';
        
        // Очищаем превью медиа
        clearMediaPreview();
        
        // Прокручиваем вниз
        chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }

      function handleChatSubmit(e) {
        e.preventDefault();
        e.stopPropagation();

        const message = chatInput.value.trim();
        const hasMedia = pendingMedia.length > 0;

        if (!message && !hasMedia) return;

        // Если идет тест, обрабатываем ответы через кнопки
        if (currentTestState.inProgress) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
          
          const botMsg = document.createElement('div');
          botMsg.className = 'message bot-message animate-fade-in';
          botMsg.textContent = 'Пожалуйста, выбирайте ответы с помощью кнопок выше для точности тестирования.';
          chatContainer.appendChild(botMsg);
          
          chatInput.value = '';
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          return;
        }

        // Add user message
        if (message) {
          const userMsg = document.createElement('div');
          userMsg.className = 'message user-message animate-fade-in';
          userMsg.textContent = message;
          chatContainer.appendChild(userMsg);
        }

        // Add media if any
        if (hasMedia) {
          pendingMedia.forEach(media => {
            const mediaMsg = document.createElement('div');
            mediaMsg.className = 'message message-image user-message animate-fade-in';
            mediaMsg.innerHTML = `<img src="${media}" alt="Sent image">`;
            chatContainer.appendChild(mediaMsg);
          });
        }

        // Force DOM update and scroll to bottom
        requestAnimationFrame(() => {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        // Clear input and media
        chatInput.value = '';
        clearMediaPreview();

        // Add bot response after delay
        setTimeout(() => {
          const answer = findAnswer(message);
          if (answer) {
            const botMsg = document.createElement('div');
            botMsg.className = 'message bot-message animate-fade-in';
            botMsg.textContent = answer;
            chatContainer.appendChild(botMsg);
            
            requestAnimationFrame(() => {
              chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
            });
          }
        }, 500);
      }

      // Event listeners
      chatFileInput.addEventListener('change', handleFileInput);
      cancelMediaButton.addEventListener('click', clearMediaPreview);
      chatForm.addEventListener('submit', handleChatSubmit);
      clearChatButton.addEventListener('click', createNewChat);

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleChatSubmit(e);
        }
      });

      // Создаем новый чат при каждой загрузке страницы
      createNewChat();
    });
  </script>
</body>
</html>